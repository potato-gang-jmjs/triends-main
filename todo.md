# 물 마을 던전 구현 계획

## 📌 프로젝트 개요
물 마을 던전은 플레이어(우주인)와 인삼이가 협력하여 마을의 물 공급을 복구하는 협동 퍼즐 던전입니다.
- **예상 소요 시간**: 15-20분
- **퍼즐 개수**: 2개 (튜토리얼 1개, 메인 1개)
- **보스전**: 1회

---

## Epic 1: 맵 시스템 구축 🗺️

### 1.1 물 마을 메인 맵 (water-village)
- [ ] 맵 데이터 구조 생성 (`/public/assets/maps/water-village/`)
  - [ ] `map.json` - 기본 맵 레이아웃 (중앙 광장, 수로, 건물 배치)
  - [ ] `layers.json` - 레이어 정의 (ground, collision, decoration)
  - [ ] `portals.json` - 수로 입구 포털 정의
- [ ] 타일셋 제작/준비
  - [ ] 마른 땅 타일
  - [ ] 갈라진 바닥 타일
  - [ ] 건물 타일셋
  - [ ] 장식 요소 (말라비틀어진 식물 등)

### 1.2 수로 맵 1 - 튜토리얼 (water-channel-1)
- [ ] 맵 크기: 15x10 타일 구성
- [ ] 맵 요소 배치
  - [ ] 입구 지점
  - [ ] 마른 식물 3개 위치
  - [ ] 물 웅덩이 2개 위치
  - [ ] 좁은 틈 (덩굴 당기기 필요)
- [ ] 충돌 레이어 설정

### 1.3 수로 맵 2 - 메인 퍼즐 (water-channel-2)
- [ ] 맵 크기: 20x15 타일 구성
- [ ] 복잡한 수로 구조 설계
- [ ] 퍼즐 요소 배치
  - [ ] 마른 수초 발판 5-6개
  - [ ] 무게 스위치 2개
  - [ ] 갇힌 아이 구출 지점

### 1.4 보스룸 맵 (water-boss)
- [ ] 맵 크기: 12x12 원형 전투 공간
- [ ] 주변 물 웅덩이 배치
- [ ] 보스 스폰 지점 설정

---

## Epic 2: NPC 시스템 구현 👥

### 2.1 NPC 데이터 구조 설계
- [ ] `/public/assets/maps/water-village/npcs.json` 생성
- [ ] NPC 타입 정의
  - [ ] 장로 (elder)
  - [ ] 주민 (villager-water)
  - [ ] 아이 (child-water)
  - [ ] 경비병 (guard-water)
  - [ ] 고래뿌리개 (whale-sprout) - 특수 NPC/오브젝트

### 2.2 대화 시스템 확장
- [ ] `/public/assets/dialogues/water-village/` 폴더 생성
- [ ] YAML 대화 파일 작성
  - [ ] `elder.yaml` - 장로 대화 (퀘스트 부여, 완료)
  - [ ] `villager-water.yaml` - 주민 대화 (갈증/회복 상태)
  - [ ] `guard-water.yaml` - 경비병 대화
  - [ ] `whale-sprout.yaml` - 고래뿌리개 부활 시퀀스
- [ ] 조건부 대화 구현
  - [ ] 물 복구 전/후 상태 변화
  - [ ] 퀘스트 진행도별 대화 변경

### 2.3 NPC 상태 시스템
- [ ] NPC 상태 관리자 구현
- [ ] 애니메이션 상태
  - [ ] 갈증 상태 (쓰러진 모습, 신음)
  - [ ] 회복 상태 (기뻐하는 모습)

---

## Epic 3: 오브젝트 시스템 확장 🎮

### 3.1 마른 식물 오브젝트
- [ ] `DriedPlantObject.ts` 클래스 생성
- [ ] 상태 관리
  - [ ] 마른 상태 (통과 불가)
  - [ ] 물을 받은 상태 (임시 발판, 5초 지속)
  - [ ] 다시 마르는 애니메이션
- [ ] 물뿌리개와의 상호작용 구현

### 3.2 무게 스위치 오브젝트
- [ ] `WeightSwitchObject.ts` 클래스 생성
- [ ] 동시 작동 메커니즘
  - [ ] 양쪽 스위치 상태 체크
  - [ ] 타이머 기반 동시성 검증 (1초 이내)
- [ ] 문 열림 트리거 연결

### 3.3 물 웅덩이 오브젝트
- [ ] `WaterPoolObject.ts` 클래스 생성
- [ ] 물뿌리개 충전 지점 기능
- [ ] 시각적 피드백 (물결 애니메이션)

### 3.4 고래뿌리개 오브젝트
- [ ] `WhaleSpoutObject.ts` - 특수 오브젝트/NPC 혼합형
- [ ] 상태 전환
  - [ ] 정지 상태 (초기)
  - [ ] 부활 애니메이션
  - [ ] 활성 상태 (물 뿜기)

---

## Epic 4: 능력 시스템 강화 💪

### 4.1 물뿌리개 시스템 확장
- [ ] 기존 `WateringCanSystem.ts` 수정
- [ ] 새로운 상호작용 추가
  - [ ] 마른 식물과의 상호작용
  - [ ] 물 요구 장치 작동
  - [ ] 인삼이 강화 메커니즘
- [ ] UI 업데이트
  - [ ] 물 잔량 표시 개선
  - [ ] 충전 가능 지점 하이라이트

### 4.2 덩굴 시스템 확장
- [ ] 기존 `VineExtensionSystem.ts` 수정
- [ ] 물 공급 상태 체크 로직
- [ ] 강화된 능력 구현

### 4.3 무지개 다리 능력 (신규)
- [ ] `RainbowBridgeSystem.ts` 생성
- [ ] 발동 조건
  - [ ] 인삼이 물 과다 흡수 상태
  - [ ] 특정 키 입력 (Q키 등)
- [ ] 다리 생성 메커니즘
  - [ ] 공중 플랫폼 생성
  - [ ] 5초 지속 후 소멸
  - [ ] 무지개 시각 효과

---

## Epic 5: 퍼즐 시스템 구현 🧩

### 5.1 퍼즐 매니저
- [ ] `PuzzleManager.ts` 생성
- [ ] 퍼즐 상태 추적
- [ ] 완료 조건 체크

### 5.2 튜토리얼 퍼즐 (마른 식물 다리)
- [ ] 퍼즐 로직 구현
- [ ] 힌트 시스템
- [ ] 완료 시 진행 트리거

### 5.3 메인 퍼즐 A (물 운반 릴레이)
- [ ] 순차적 활성화 로직
- [ ] 물 사용 최적화 체크
- [ ] 실패 시 리셋 메커니즘

### 5.4 메인 퍼즐 B (동시 스위치)
- [ ] 협동 필수 메커니즘
- [ ] 타이밍 검증 시스템
- [ ] 성공 시 보스룸 개방

---

## Epic 6: 보스전 구현 👾

### 6.1 흡수 해파리 보스
- [ ] `AbsorbJellyfishBoss.ts` 생성
- [ ] 보스 패턴
  - [ ] 물 흡수 공격
  - [ ] 촉수 공격
  - [ ] 전체 공격 패턴
- [ ] HP 시스템
- [ ] 페이즈 전환

### 6.2 보스전 메커니즘
- [ ] 협동 공격 패턴
  - [ ] 우주인 물뿌리기로 약화
  - [ ] 인삼이 덩굴로 코어 공격
- [ ] 보스 처치 시퀀스
- [ ] 보상 및 컷신

---

## Epic 7: 진행도 시스템 📊

### 7.1 플래그 시스템
- [ ] `ProgressFlags.ts` 구현
- [ ] 주요 플래그 정의
  ```typescript
  - water_village_entered
  - water_quest_started
  - channel_1_cleared
  - channel_2_cleared
  - boss_defeated
  - water_restored
  - whale_revived
  ```

### 7.2 세이브 포인트
- [ ] 세이브 위치 설정
  - [ ] 물 마을 입구
  - [ ] 수로 1 시작
  - [ ] 수로 2 시작
  - [ ] 보스전 직전
- [ ] 자동 저장 구현

### 7.3 퀘스트 시스템
- [ ] `QuestManager.ts` 생성
- [ ] 메인 퀘스트: "지하 수로의 원인을 제거하라"
- [ ] 진행 상황 UI 표시

---

## Epic 8: 시각 효과 및 애니메이션 ✨

### 8.1 환경 효과
- [ ] 마른 땅 파티클 효과
- [ ] 물 흐름 애니메이션
- [ ] 고래뿌리개 물 분사 효과

### 8.2 캐릭터 애니메이션
- [ ] NPC 갈증 애니메이션
- [ ] 회복 시 기쁨 표현
- [ ] 고래뿌리개 부활 시퀀스

### 8.3 능력 시각 효과
- [ ] 무지개 다리 셰이더 효과
- [ ] 물뿌리개 물방울 파티클
- [ ] 덩굴 확장 애니메이션 개선

---

## Epic 9: 사운드 및 음악 🎵

### 9.1 배경음악
- [ ] 물 마을 테마 (우울한 분위기)
- [ ] 수로 던전 BGM
- [ ] 보스전 전투 음악
- [ ] 승리 팡파레

### 9.2 효과음
- [ ] 물뿌리개 사용음
- [ ] 식물 성장음
- [ ] 스위치 작동음
- [ ] 보스 공격/피격음

---

## Epic 10: 테스트 및 밸런싱 🔧

### 10.1 플레이 테스트
- [ ] 싱글 플레이 가능 여부 체크
- [ ] 협동 필수 구간 검증
- [ ] 난이도 조정

### 10.2 버그 수정
- [ ] 충돌 감지 이슈
- [ ] 퍼즐 시퀀스 브레이킹
- [ ] 세이브/로드 안정성

### 10.3 최적화
- [ ] 맵 로딩 속도
- [ ] 메모리 사용량
- [ ] 프레임 드랍 구간 개선

---

## 🎯 마일스톤

### Phase 1: 기초 구축 (Week 1-2)
- Epic 1: 맵 시스템 구축
- Epic 2: NPC 시스템 구현
- Epic 3: 오브젝트 시스템 확장

### Phase 2: 핵심 메커니즘 (Week 3-4)
- Epic 4: 능력 시스템 강화
- Epic 5: 퍼즐 시스템 구현
- Epic 6: 보스전 구현

### Phase 3: 진행 및 연출 (Week 5)
- Epic 7: 진행도 시스템
- Epic 8: 시각 효과 및 애니메이션

### Phase 4: 마무리 (Week 6)
- Epic 9: 사운드 및 음악
- Epic 10: 테스트 및 밸런싱

---

## 📝 우선순위 작업

### 즉시 시작 가능한 작업들:
1. 맵 데이터 구조 생성 (Epic 1.1)
2. NPC 데이터 구조 설계 (Epic 2.1)
3. 마른 식물 오브젝트 구현 (Epic 3.1)
4. 물뿌리개 시스템 확장 (Epic 4.1)

### 의존성이 있는 작업들:
1. 퍼즐 구현 → 맵과 오브젝트 완성 필요
2. 보스전 → 전투 시스템과 능력 완성 필요
3. 진행도 시스템 → 전체 플로우 완성 필요

---

## 🔄 지속적 작업

- 코드 리뷰 및 리팩토링
- 문서화 업데이트
- 플레이테스트 피드백 반영
- 성능 모니터링

---

**작성일**: 2025-01-28
**예상 완료일**: 6주 후
**담당팀**: Game Development Team